<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Verificação de Identidade • Xlunas</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <main class="card" style="max-width:600px">
    <h1>Verifique sua identidade</h1>
    <p class="small">Precisamos confirmar que você é maior de 18 anos. Envie:</p>
    <ol class="small">
      <li>Foto da <strong>frente</strong> do documento</li>
      <li>Foto do <strong>verso</strong> do documento</li>
      <li><strong>Selfie</strong> segurando o documento</li>
    </ol>

    <form id="kycForm">
      <label>Frente do documento
        <input type="file" id="front" accept="image/*" required />
      </label>
      <label>Verso do documento
        <input type="file" id="back" accept="image/*" required />
      </label>
      <label>Selfie com documento
        <input type="file" id="selfie" accept="image/*" required />
      </label>
      <button id="sendBtn" type="submit">Enviar para análise</button>
      <progress id="progress" value="0" max="100" hidden></progress>
      <p id="msg" class="msg"></p>
    </form>
  </main>

  <script type="module">
    import { supabase } from './supabase.js';

    const form   = document.getElementById('kycForm');
    const front  = document.getElementById('front');
    const back   = document.getElementById('back');
    const selfie = document.getElementById('selfie');
    const btn    = document.getElementById('sendBtn');
    const prog   = document.getElementById('progress');
    const msgP   = document.getElementById('msg');

    // Redireciona se não estiver logado
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) window.location.href = '/';

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      btn.disabled = true;
      msgP.textContent = '';

      // uploads paralelos para o bucket "kyc"
      const bucket = 'kyc';
      const pathBase = `${session.user.id}/${Date.now()}`;
      const files = [front.files[0], back.files[0], selfie.files[0]];
      const names = ['front', 'back', 'selfie'];
      const urls  = [];
      let uploaded = 0;
      for (let i=0;i<3;i++) {
        const path = `${pathBase}_${names[i]}.png`;
        const { error } = await supabase.storage.from(bucket).upload(path, files[i], { upsert:false });
        if (error) {
          msgP.textContent = 'Falha no upload. Tente novamente.';
          btn.disabled = false;
          return;
        }
        const { data:{ publicUrl } } = supabase.storage.from(bucket).getPublicUrl(path);
        urls.push(publicUrl);
        uploaded++;
        prog.hidden = false;
        prog.value = uploaded * 33;
      }
      prog.value = 100;

      // grava na tabela kyc_requests
      const { error: insErr } = await supabase
        .from('kyc_requests')
        .insert({
          user_id: session.user.id,
          front_url: urls[0],
          back_url: urls[1],
          selfie_url: urls[2],
          status: 'pending'
        });
      if (insErr) {
        msgP.textContent = insErr.message;
        btn.disabled = false;
        return;
      }
      msgP.textContent = 'Enviado! Aguarde análise.';
    });
  </script>
</body>
</html>
