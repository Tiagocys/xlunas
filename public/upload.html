<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Enviar conteúdo • Xlunas</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <main class="card" style="max-width:600px">
    <h1>Enviar vídeo ou foto</h1>

    <form id="uploadForm">
      <label>Arquivo (MP4, MOV, JPG, PNG)
        <input type="file" id="fileInput" accept="video/*,image/*" required />
      </label>

      <label>Título
        <input type="text" id="title" maxlength="120" required />
      </label>

      <label>Descrição (opcional)
        <textarea id="description" maxlength="500" rows="3"></textarea>
      </label>

      <button type="submit">Enviar</button>
      <progress id="progress" value="0" max="100" hidden></progress>
      <p id="msg" class="msg"></p>
    </form>
  </main>
  
  <script src="https://unpkg.com/tus-js-client@^2/dist/tus.js"></script>
  <script type="module">
    import { supabase } from './supabase.js';

    const form      = document.getElementById('uploadForm');
    const fileInput = document.getElementById('fileInput');
    const progress  = document.getElementById('progress');
    const msgP      = document.getElementById('msg');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      msgP.textContent = '';
      const file = fileInput.files[0];
      if (!file) return;

      const isVideo  = file.type.startsWith('video/');
      const endpoint = isVideo
        ? 'https://x-lunas.cysneirostiago.workers.dev/stream-direct-upload'
        : '/image-direct-upload';

      // 1) Pega uploadURL + uid no Worker
      const tokenRes = await fetch(endpoint, { method: 'POST' });
      if (!tokenRes.ok) {
        msgP.textContent = 'Erro gerando token de upload.';
        return;
      }
      const { uploadURL, uid } = await tokenRes.json();

      // 2) Usa tus-js-client para o upload resumable
      progress.hidden = false;
      const upload = new tus.Upload(file, {
        endpoint: uploadURL,
        retryDelays: [0, 1000, 3000, 5000],
        metadata: {
          filename: file.name,
          filetype: file.type
        },
        onError: (error) => {
          msgP.textContent = `Upload falhou: ${error}`;
          progress.hidden = true;
        },
        onProgress: (bytesUploaded, bytesTotal) => {
          const pct = ((bytesUploaded/bytesTotal)*100).toFixed(2);
          progress.value = pct;
        },
        onSuccess: async () => {
          // 3) Grava no Supabase
          const {
            data: { session },
            error: sessErr
          } = await supabase.auth.getSession();
          if (sessErr || !session) {
            msgP.textContent = 'Sessão expirada.';
            return;
          }

          const { error } = await supabase
            .from('posts')
            .insert({
              creator_id : session.user.id,
              media_url  : uid,
              media_type : isVideo ? 'video' : 'image',
              title      : title.value.trim(),
              description: description.value.trim(),
              is_private : true
            });
          if (error) msgP.textContent = error.message;
          else {
            msgP.textContent = 'Upload concluído!';
            form.reset();
          }
          progress.hidden = true;
        }
      });

      upload.start();
    });
  </script>
</body>
</html>
